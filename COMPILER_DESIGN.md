> **Note:** This document describes the **intended design** for an automated fluid compiler. The implementation in `build_fluids.py` is currently **incomplete** and does not perform all the functions described here. The current method for adding new fluids is a manual process. Please refer to `FluidsAPI.md` for details on the current manual workflow.

# Bedrock Fluids Compiler Design

This document outlines the design for a central compiler script that automates the creation and management of custom fluids. The goal is to allow users to define fluids in a single configuration file, and have the compiler generate all the necessary assets and code.

## Core Principle: Single Source of Truth

The entire system will be driven by a single configuration file named `fluids.config.json`. This file will contain an array of fluid definitions, where each fluid has a set of properties. This eliminates the need for manual editing of multiple JSON and JavaScript files, reducing errors and simplifying the process of adding or modifying fluids.

## User Workflow

To create one or more new fluids, the user will perform the following steps:

1.  **Create Textures**: For each new fluid (e.g., "honey"), the user must create the necessary `.png` texture files and place them in the resource pack's texture directory.
    *   `honey_still.png` (for the top surface of a source block)
    *   `honey_flow.png` (for the top surface of a flowing block)
    *   `honey_bucket.png` (for the bucket item)

2.  **Update Configuration**: The user will add a new entry to the `fluids.config.json` file.

    ```json
    {
      "fluids": [
        {
          "id": "oil",
          "name": "Oil",
          "maxSpreadDistance": 7,
          "tickDelay": 20
        },
        {
          "id": "honey",
          "name": "Honey",
          "maxSpreadDistance": 4,
          "tickDelay": 40
        }
      ]
    }
    ```

3.  **Run the Compiler**: The user will execute the main compiler script from the command line.
    ```bash
    python build_fluids.py
    ```

## Compiler Architecture (`build_fluids.py`)

The compiler script will perform the following sequence of tasks:

### 1. Read Configuration
- The script will start by parsing `fluids.config.json` to get the list of all fluid objects to be processed.

### 2. Generate Universal Assets
- The script will generate the universal (fluid-agnostic) geometry and permutation files. This is a one-time operation.
- **`fluid_geometry.json`**: Contains the 3D models for all fluid depths and slopes. The identifiers will be generic (e.g., `geometry.lumstudio.fluid.5_n`).
- **`fluid_block_permutations.json`**: Contains the Molang queries that map a block's integer `lumstudio:depth` state and `slope` state to the correct generic geometry.

### 3. Generate Per-Fluid Files
- The script will iterate through each fluid defined in the configuration and generate the following files, using the fluid's `id` and `name` for naming.

#### Behavior Pack (`BP fluids/`)
- **Block Definition**: `BP/blocks/<fluid_id>.json`
  - This file will define the `lumstudio:<fluid_id>` block.
  - It will set its `minecraft:block` properties and attach the custom `lumstudio:fluidBehavior` component (if we keep it) or simply rely on the global listener.
- **Bucket Item**: `BP/items/<fluid_id>_bucket.json`
  - Defines the `lumstudio:<fluid_id>_bucket` item.
  - Includes a component that gives it the `placer:<fluid_id>` tag, which the scripts use to identify which fluid to place.

#### Resource Pack (`RP fluids/`)
- **`blocks.json`**: The script will programmatically add a new entry for each fluid, mapping its block ID to the correct textures.
  ```json
  "lumstudio:honey": {
    "textures": {
      "up": "textures/blocks/honey_still",
      "down": "textures/blocks/honey_flow",
      "side": "textures/blocks/honey_flow"
    },
    "sound": "bucket.fill_lava"
  }
  ```
- **`item_texture.json`**: Adds an entry for the fluid's bucket item.
  ```json
  "lumstudio:honey_bucket": {
    "textures": "textures/items/honey_bucket"
  }
  ```
- **`terrain_texture.json`**: Adds entries for the fluid's textures.
  ```json
  "honey_still": { "textures": "textures/blocks/honey_still" },
  "honey_flow": { "textures": "textures/blocks/honey_flow" }
  ```

### 4. Generate JavaScript Registration
- The compiler will generate a new, non-editable file: `BP/scripts/generated/register_fluids.js`.
- This file will export the `Queues` object, which contains an initialized `FluidQueue` for each fluid defined in the config.
- The `tickDelay` from the config will be passed to the `FluidQueue` constructor.

    ```javascript
    // ---- THIS FILE IS AUTO-GENERATED BY build_fluids.py. DO NOT EDIT. ----
    import { FluidQueue } from "../queue";
    import { fluidUpdate } from "../API";

    export const Queues = {
      "lumstudio:oil": new FluidQueue(fluidUpdate, "lumstudio:oil", 20),
      "lumstudio:honey": new FluidQueue(fluidUpdate, "lumstudio:honey", 40),
    };
    ```
- The main, hand-written `API.js` file will then import this `Queues` object, keeping the core logic clean and decoupled from the specific fluid implementations.

This approach provides a robust, scalable, and user-friendly system for creating custom fluids in Minecraft Bedrock Edition.